% Load data from Messdaten.mat
load('Messdaten.mat');

% Define the time range of interest
start_time = 86.566; % Start time in seconds
end_time = 86.616;   % End time in seconds

% Extract data within the specified time range
time_range_indices = frq_el_intern(:,2) >= start_time & frq_el_intern(:,2) <= end_time;
Frequenz = frq_el_intern(time_range_indices, 1);

% Specify the pulses per revolution
pulses_per_revolution = 4;

% Calculate rotor speed (RPM) of the motor
RPM = (Frequenz * 60) / pulses_per_revolution;

% Perform FFT on the RPM data
N = numel(RPM); % Length of the signal
Fs = 1 / (Zeit(2) - Zeit(1)); % Sampling frequency in Hz
RPM_fft = fft(RPM, N); % Compute FFT

% Calculate the magnitude of the FFT signal (including both positive and negative frequencies)
RPM_fft_mag = abs(RPM_fft) / N; % Normalize by the number of samples

% Define frequencies corresponding to FFT bins
frequencies = Fs * (-N/2:N/2-1) / N;

% Define fundamental frequency (1x)
fundamental_frequency = mean(RPM);

% Define harmonic frequencies (w, 2w, 3w, 4w, 5w, 6w)
num_harmonics = 6;
harmonic_frequencies = fundamental_frequency * (1:num_harmonics);

% Perform harmonic analysis
harmonic_magnitudes = zeros(1, num_harmonics);
for i = 1:num_harmonics
    harmonic_magnitudes(i) = max(abs(RPM - i * fundamental_frequency));
end

% Display harmonic analysis results in tabular format
disp('Harmonic Analysis Results:');
disp('--------------------------');
disp('Harmonic   Frequency (RPM)   Magnitude');
for i = 1:num_harmonics
    fprintf('%8d \t %10.2f \t %10.4f\n', i, harmonic_frequencies(i), harmonic_magnitudes(i));
end

% Plot the squish plot for the frequency spectrum with harmonic peaks
figure;
plot(frequencies, 10*log10(RPM_fft_mag));
xlabel('Frequency (Hz)');
ylabel('Magnitude (dB)');
title('Squish Plot of Frequency Spectrum of Rotor Speed (RPM)');
grid on;

% Plot the squish plot for the harmonic analysis results
figure;
stem(harmonic_frequencies, 10*log10(harmonic_magnitudes), 'r', 'Marker', 'none');
xlabel('Frequency (RPM)');
ylabel('Magnitude (dB)');
title('Squish Plot of Harmonic Analysis of Rotor Speed (RPM)');
grid on;

% Save the plots as PNG files
print('-dpng', 'Squish_Plot_Frequency_Spectrum_Rotor_Speed.png');
print('-dpng', 'Squish_Plot_Harmonic_Analysis_Rotor_Speed.png');
